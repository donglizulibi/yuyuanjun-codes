<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        class Axios {
            constructor(config) {
                this.config = config
            }

            request(config) {
                let promise = Promise.resolve(config)
                let chains = [dispatchRequest, undefined]
                let result = promise.then(chains[0], chains[1])

                console.log(result)
                return result
            }
        }


        // 
        function dispatchRequest(config) {
            console.log('dispatchRequest函数')


            return xhrAdapter(config).then((response) => {
                console.log(response)

                // 在这里可以对response数据再次进行处理
                // 在源码中是把response.data赋值为一个transformData的返回值

                // 在这里直接返回response
                return response
            }, (error) => {
                throw new Error('请求失败')
            })
        }

        function xhrAdapter(config) {
            console.log('xhrAdapter 函数运行')
            return new Promise((resolve, reject) => {

                let xhr = new XMLHttpRequest();
                xhr.open(config.method, config.url)
                xhr.send()
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve({
                                config: config,
                                data: xhr.response,
                                headers: xhr.getAllResponseHeaders(),
                                request: xhr,
                                status: xhr.status,
                                statusText: xhr.statusText
                            })

                        } else {
                            reject(new Error('请求失败，状态码为：' + xhr.status))
                        }
                    }
                }

            })
        }

        let axios = Axios.prototype.request.bind(null)

        // 此时把config实参传入
        axios({
            method: 'GET',
            url: 'http://127.0.0.1:3003/posts'
        }).then(val => {
            // 在这里可以打印出dispatchRequest函数的返回值
            console.log(val)
        })
    </script>
</body>

</html>