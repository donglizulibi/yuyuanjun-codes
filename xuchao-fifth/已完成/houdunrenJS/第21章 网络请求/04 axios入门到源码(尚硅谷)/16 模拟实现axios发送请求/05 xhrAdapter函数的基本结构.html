<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        class Axios {
            constructor(config) {
                this.config = config
            }

            request(config) {
                let promise = Promise.resolve(config)
                let chains = [dispatchRequest, undefined]
                let result = promise.then(chains[0], chains[1])
                return result
            }
        }

        function dispatchRequest(config) {
            console.log('dispatchRequest函数')


            return xhrAdapter(config).then((response) => {
                // 这个位置先打印，后面再修改
                console.log(response)
            }, (error) => {
                console.log(error)
            })
        }

        function xhrAdapter(config) {
            console.log('xhrAdapter 函数运行')
            return new Promise((resolve, reject) => {
                // 在这个位置发送ajax请求

                // 还是发送ajax请求的四个步骤
                // 1 创建对象 2 调用open方法 3 调用send方法 4 处理响应结果

                let xhr = new XMLHttpRequest();
                xhr.responseType = 'json'
                xhr.open(config.method, config.url)
                xhr.send()
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            // 进入到成功接收到响应结果的部分
                            // 将需要的信息resolve出去
                            resolve({
                                // 配置对象
                                config: config,

                                // 响应数据，或者称为响应体
                                data: xhr.response,

                                // 响应头
                                headers: xhr.getAllResponseHeaders(),
                                // 响应头是字符串格式

                                // XMLHttpRequest对象
                                request: xhr,

                                // 响应状态码
                                status: xhr.status,

                                // 响应状态字符串
                                statusText: xhr.statusText
                            })

                        } else {
                            reject(new Error('请求失败，状态码为：' + xhr.status))
                        }
                    }
                }

            })
        }

        let axios = Axios.prototype.request.bind(null)

        // 此时把config实参传入，请求发送成功
        axios({
            method: 'GET',
            url: 'http://127.0.0.1:3003/posts'
        }).then(val => {
            // 在这里可以打印出dispatchRequest函数的返回值
            // 由于在这里dispatchRequest中的then没有返回值
            // 所以打印的是undefined
            console.log(val)
        })
    </script>
</body>

</html>